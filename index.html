<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <script>
        setTimeout(function() {
            Telegram.WebApp.ready();
            let params = new URL(window.location).searchParams;
            
            let bot_token = params.get('bot_token');
            let players = JSON.parse(decodeURIComponent(params.get('players')));
                        
            let chat_id = players[0];
            chat_id = 396208817;
            players.push(players.shift());
            players = encodeURIComponent(JSON.stringify(players));
            
            document.getElementById('info').innerText = 'Sending...';
            
            setTimeout(function() {                
                let url = `https://api.telegram.org/bot${bot_token}/sendMessage`;
                let request_json = {
                    'chat_id': chat_id,
                    'text': 'Твой ход ' + JSON.stringify(JSON.parse(decodeURIComponent(params.get('players')))),
                    'reply_markup': {
                        'inline_keyboard': [[{
                            "text": "Ход окончен",
                            "web_app": {
                                "url": `https://55aah.github.io/unciv_notifier_bot_proxy?bot_token=${bot_token}&players=${players}`,
                            },
                        }]],
                    },
                };
                fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(request_json)}).then((response) => {
                    return response.json();
                }).then((data) => {
                    console.log(data);
                    document.getElementById('info').innerText = JSON.stringify(request_json) + '\n\n' + JSON.stringify(data);
                    if (data['ok']) {
                        Telegram.WebApp.close();
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }, 3000);
        }, 3000);
      </script>
   </head>
   <body>
      <p id='info'>Wait...<p>
   </body>
</html>
